#!/usr/bin/env ruby

require 'lerna/runner'

LOGGER = lambda { |str|
  time = Time.now.utc
  timestamp = time.strftime('%Y-%m-%dT%H:%M:%S.') << '%06dZ' % time.usec
  puts '[%s #%d] %s' % [timestamp, Process.pid, str]
}

strategies = %w[
  external-digital-only
  internal-only
]

trap('TERM') {
  log 'Exiting'
  exit
}

# def system(*args)
#   LOGGER.call(args.join(' '))
# end

runner = Lerna::Runner.new(
  logger: LOGGER,
  strategies: strategies,
  system: method(:system)
)

loop do
  runner.run
  sleep 2
end
